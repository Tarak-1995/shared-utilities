# Deploy to Azure Kubernetes Service
# Build and push image to Azure Container Registry; Deploy to Azure Kubernetes Service
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  - master
  
resources:
  - repo: self
  
variables:
  
  # Env vars
  buildConfiguration: 'Release'
  buildPlatform: 'Any CPU'
  #Version: ''
  
  # .sln .csproj(UnitTests) relative paths
  project_sln: "PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.sln"
  project_csproj: "./PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/PrimeroEdge.SharedUtilities.Api.csproj"
  test_csproj: "./PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.UnitTests/PrimeroEdge.SharedUtilities.UnitTests.csproj"
  
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '080de9e3-d7ce-498e-947e-3a9429ac3931'
  imageRepository: 'sharedutilities_qa'
  containerRegistry: 'perseusnonprodacr.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'perseusnonprodacr10848ea9-auth'
  helmChartPath: './PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/devops/deployment/sharedutilities/'
  # Agent VM image name
  vmImageNameW: 'vs2017-win2016'
  vmImageNameU: 'ubuntu-latest'
  

stages:
- stage: BuildandAnalysis
  displayName: Build and Analysis
  jobs:
  - job: SLNBuild
    steps:
    - task: NuGetCommand@2
      inputs:  
        restoreSolution:  '--configfile NuGet.Config $(project_sln)'
    - script: dotnet build --configuration $(buildConfiguration)
      workingDirectory: "./PrimeroEdge.SharedUtilities"
      displayName: 'dotnet build $(buildConfiguration)'
    
  - job: CodeAM
    displayName: Code Analysis and Metrics
    dependsOn: SLNBuild 
    pool:
      vmImage: $(vmImageNameW)
    steps:
    - task: DotNetCoreCLI@2
      inputs:
        command: build
        projects: '$(project_csproj)'
        arguments: '/p:RunCodeAnalysis=true'
        configuration: '$(buildConfiguration)'
    
    - task: DotNetCoreCLI@2
      inputs:
        command: test
        projects: '$(test_csproj)'
        arguments: '--configuration $(buildConfiguration)'

    - task: AzurePowerShell@5
      inputs:
        azureSubscription: 'Perseus Non-Prod (b0b91233-8bb9-44e7-b548-84412ecc5c0d)'
        ScriptType: 'FilePath'
        ScriptPath: 'PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/devops/deployment/version.ps1'
        azurePowerShellVersion: 'LatestVersion'
    
- stage: ImageBuild
  displayName: Image Build $ Push
  dependsOn: BuildandAnalysis
  pool:
    vmImage: $(vmImageNameU)
  jobs:
  - job: ImageBuild
    steps:
    - task: Docker@2
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(Version)
          latest
    
- stage: HelmInstall
  displayName: Helm Installs
  dependsOn: ImageBuild
  jobs: 
  - job: Init
    steps:
    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: 'latest'
  
- stage: HelmPackage
  displayName: Helm Chart Package
  dependsOn: HelmInstall
  jobs: 
  - job: HelmPackage
    displayName: Helm Package
    steps:
    - task: HelmDeploy@0
      inputs:
        command: 'package'
        chartPath: $(helmChartPath)
        destination: $(Build.ArtifactStagingDirectory)
        chartName: 'sharedutilities'  
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Pipeline.Workspace)/a/sharedutilities-0.1.0.tgz'
        artifact: 'sharedutilities-qa'
        publishLocation: 'pipeline'
        
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: 'PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/devops/deployment/sharedutilities'
        artifact: 'qa_values'
        publishLocation: 'pipeline'
    
- stage: Secret
  displayName: Generate secret
  dependsOn: HelmPackage
  jobs: 
  - job: QAKubesecret
    displayName: Kubernetes QA Secret
    steps:
    - task: Kubernetes@1
      inputs:
        connectionType: 'Kubernetes Service Connection'
        kubernetesServiceEndpoint: 'Perseus-Non-prod-AKS-eastus-QA'
        namespace: 'qa'
        secretType: 'generic'
        secretArguments: '--from-file=PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/appsettings.QA.json' 
        secretName: 'sharedutilities-qa-secret-appsettings'