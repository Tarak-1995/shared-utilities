# Deploy to Azure Kubernetes Service
# Build and push image to Azure Container Registry; Deploy to Azure Kubernetes Service
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- $(Build.SourceBranch)

name: '1.0$(Rev:.r)'

resources:
- repo: self

variables:
  # Env vars
  buildConfiguration: 'Release'
  buildPlatform: 'Any CPU'
  HELM_EXPERIMENTAL_OCI: 1
  imageVersion: $(Build.BuildNumber)
  helmChartVersion: $(Build.BuildNumber)
  imageName: PerseusNonProdACR.azurecr.io/sharedutilities-dev:$(Build.BuildNumber)
  # .sln .csproj(UnitTests) relative paths
  project_sln: "PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.sln"
  project_csproj: "./PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/PrimeroEdge.SharedUtilities.Api.csproj"
  test_csproj: "./PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.UnitTests/PrimeroEdge.SharedUtilities.UnitTests.csproj"
  

  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '0308b8a7-8ae6-4c18-b610-58fe54dc62c4'
  imageRepository: 'sharedutilities-dev'
  projectName: 'sharedutilities'
  helmchartdev: 'sharedutilities-dev'
  containerRegistry: 'perseusnonprodacr.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'perseusnonprodacr206701cc-auth'

  helmChartPath: './PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/devops/deployment/sharedutilities/'
  # Agent VM image name
  vmImageNameW: 'vs2017-win2016'
  vmImageNameU: 'ubuntu-latest'

stages:
- stage: BuildandAnalysis
  displayName: Build and Analysis
  jobs:
  - job: SLNBuild
    steps:
    - task: NuGetCommand@2
      inputs:  
        restoreSolution:  '--configfile NuGet.Config $(project_sln)'
    - script: dotnet build --configuration $(buildConfiguration)
      workingDirectory: "./PrimeroEdge.SharedUtilities"
      displayName: 'dotnet build $(buildConfiguration)'
  
  - job: CodeAM
    displayName: Code Analysis and Metrics
    dependsOn: SLNBuild 
    pool:
      vmImage: $(vmImageNameW)
    steps:
    - task: DotNetCoreCLI@2
      inputs:
        command: build
        projects: '$(project_csproj)'
        arguments: '/p:RunCodeAnalysis=true'
        configuration: '$(buildConfiguration)'

    - task: DotNetCoreCLI@2
      inputs:
        command: test
        projects: '$(test_csproj)'
        arguments: '--configuration $(buildConfiguration)'

- stage: ImageBuild
  displayName: Image Build $ Push
  dependsOn: BuildandAnalysis
  pool:
    vmImage: $(vmImageNameU)
  jobs:
  - job: ImageBuild
    steps:  
    - task: Docker@2
      displayName: Image Build $ Push
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest
  
- stage: HelmInstall
  displayName: Helm Installs
  dependsOn: ImageBuild
  jobs: 
  - job: Init
    steps:
    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: '3.2.3'
    - bash: |
          echo $(registryPassword) | helm registry login $(registryName).azurecr.io --username $(registryLogin) --password-stdin
          cd PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/devops/deployment
          helm chart save $(helm package --app-version $(imageVersion) --version $(helmChartVersion) ./$(projectName) | grep -o '/.*.tgz') $(registryName).azurecr.io/charts/$(helmchartdev):$(imageVersion)
          helm chart push $(registryName).azurecr.io/charts/$(helmchartdev):$(imageVersion)
          echo $(jq -n --arg version "$(helmChartVersion)" '{helmChartVersion: $version}') > $(build.artifactStagingDirectory)/variables.json
      failOnStderr: true
      displayName: "helm package"

- stage: HelmPackage
  displayName: Helm Chart Package
  dependsOn: HelmInstall
  jobs: 
  - job: HelmPackage
    displayName: Helm Package
    steps:
    - task: HelmDeploy@0
      inputs:
        command: 'package'
        chartPath: $(helmChartPath)
        destination: $(Build.ArtifactStagingDirectory)
        chartName: 'sharedutilities'


  
- stage: Secret
  displayName: Generate secret
  dependsOn: HelmPackage
  jobs: 
  - job: DevKubesecret
    displayName: Kubernetes Secret
    steps:
    - task: Kubernetes@1
      inputs:
        connectionType: 'Kubernetes Service Connection'
        kubernetesServiceEndpoint: 'perseus-sharedutilities-dev'
        namespace: 'test'
        secretType: 'generic'
        secretArguments: '--from-file=PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/appsettings.Development.json'
        secretName: 'sharedutilities-dev-secret-appsettings'
