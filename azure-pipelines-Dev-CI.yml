#################################################################################################
#
#
# Shared Utilities UI CI pipeline
# Deploy to Azure Kubernetes Service
# Build and push image to Azure Container Registry
# Deploy to Azure Kubernetes Service
# Update argocd infra repo with latest docker image tag
#
#
#################################################################################################

trigger:
- $(Build.SourceBranch)

name: $(ReleaseNumber).$(Date:MMdd).$(Rev:r)

resources:
- repo: self

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Env vars
  buildConfiguration: 'Release'
  buildPlatform: 'Any CPU'
  HELM_EXPERIMENTAL_OCI: 1
  imageVersion: $(Build.BuildNumber)
  helmChartVersion: $(Build.BuildNumber)
  imageName: PerseusNonProdACR.azurecr.io/sharedutilities-dev:$(Build.BuildNumber)
  project_sln: "PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.sln"
  project_csproj: "./PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.Api/PrimeroEdge.SharedUtilities.Api.csproj"
  test_csproj: "./PrimeroEdge.SharedUtilities/PrimeroEdge.SharedUtilities.UnitTests/PrimeroEdge.SharedUtilities.UnitTests.csproj"
  devschoolcafeimagerepository: 'schoolcafe-dev/sharedutilities.devschoolcafe'
  imageRepository: 'sharedutilities-dev'
  projectName: 'sharedutilities'
  helmchartdev: 'sharedutilities-dev'
  containerRegistry: 'perseusnonprodacr.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  vmImageNameW: 'windows-latest'
  vmImageNameU: 'ubuntu-latest'

stages:
- stage: DockerVersion
  displayName: Generate docker version
  jobs:
    - job: Generate
      steps:
        - bash: |
            longcommithash=$(Build.SourceVersion)
            builtOn=$(date '+%Y%m%d')
            echo "##vso[task.setvariable variable=shorthash;isOutput=true]$(echo $builtOn-${longcommithash::9})"
          name: CommitSHA

- stage: BuildandAnalysis
  displayName: Build and Analysis
  dependsOn: DockerVersion
  jobs:
  - job: SLNBuild
    steps:
    - task: NuGetCommand@2
      inputs:  
        restoreSolution:  '--configfile NuGet.Config $(project_sln)'
    - script: dotnet build --configuration $(buildConfiguration)
      workingDirectory: "./PrimeroEdge.SharedUtilities"
      displayName: 'dotnet build $(buildConfiguration)'
  
  - job: CodeAM
    displayName: Code Analysis and Metrics
    dependsOn: SLNBuild 
    pool:
      vmImage: $(vmImageNameW)
    steps:
    - task: DotNetCoreCLI@2
      inputs:
        command: build
        projects: '$(project_csproj)'
        arguments: '/p:RunCodeAnalysis=true'
        configuration: '$(buildConfiguration)'

    - task: DotNetCoreCLI@2
      inputs:
        command: test
        projects: '$(test_csproj)'
        arguments: '--configuration $(buildConfiguration)'

- stage: DevSchoolCafeImageBuild
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))
  displayName:  Dev SchoolCafe Image Build $ Push
  dependsOn:
  - DockerVersion
  - BuildandAnalysis
  jobs:
  - job: ImageBuildDevSchoolCafe
    variables:
      commitSHA: $[stageDependencies.DockerVersion.Generate.outputs['CommitSHA.shorthash']]
    steps:
    - task: Docker@2
      displayName: Build docker image
      inputs:
        command: buildAndPush
        repository: $(devschoolcafeimagerepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest
          $(commitSHA)
 
    - bash: |
        git config --global user.email "azuredevops@primeroedge.com"
        git config --global user.name "azuredevops"
        git clone https://$(DEVOPS_USER):$(DEVOPS_TOKEN)@dev.azure.com/Cybersoft-Technologies-Inc/ArgoCD/_git/perseus-devqa-infra
        cd perseus-devqa-infra
        git checkout Develop

        dockerImageUrl="perseusnonprodacr.azurecr.io/$(devschoolcafeimageRepository):$(commitSHA)"
        sed -i "/image/c\image: $dockerImageUrl" $(helmValuesFile)

        git add .
        git commit -m 'AzDevops Image update commit sha: $(commitSHA)'
        git push origin Develop
      displayName: Update infra image tag
